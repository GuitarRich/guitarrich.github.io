<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Advanced Cache Clearing | Sitecore Nuts &amp; Bolts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="A recent post on Stack Overflow asked about clearing out the HtmlCache for a specific user, the short answer is in the post. But I thought I’d add some more detail to that answer here for anyone else">
<meta property="og:type" content="article">
<meta property="og:title" content="Advanced Cache Clearing">
<meta property="og:url" content="http://www.sitecorenutsbolts.net/2016/04/26/Advanced-Cache-Clearing/index.html">
<meta property="og:site_name" content="Sitecore Nuts &amp; Bolts">
<meta property="og:description" content="A recent post on Stack Overflow asked about clearing out the HtmlCache for a specific user, the short answer is in the post. But I thought I’d add some more detail to that answer here for anyone else">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://www.sitecorenutsbolts.net/2016/04/26/Advanced-Cache-Clearing/cacheoverview.jpg">
<meta property="og:image" content="http://www.sitecorenutsbolts.net/2016/04/26/Advanced-Cache-Clearing/cachevaryby.gif">
<meta property="og:image" content="http://www.sitecorenutsbolts.net/2016/04/26/Advanced-Cache-Clearing/userprofilecache.gif">
<meta property="og:image" content="http://www.sitecorenutsbolts.net/2016/04/26/Advanced-Cache-Clearing/userprofilerendering.png">
<meta property="og:updated_time" content="2020-05-12T14:52:21.681Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Advanced Cache Clearing">
<meta name="twitter:description" content="A recent post on Stack Overflow asked about clearing out the HtmlCache for a specific user, the short answer is in the post. But I thought I’d add some more detail to that answer here for anyone else">
<meta name="twitter:image" content="http://www.sitecorenutsbolts.net/2016/04/26/Advanced-Cache-Clearing/cacheoverview.jpg">
  
  

  <link rel="stylesheet" href="/css/style.css">
  
  
  


  

<!--
  
    <link href='//fonts.useso.com/css?family=Titillium+Web:300,400,600' rel='stylesheet' type='text/css'>
    <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
-->
</head>
</html>
<body>
  <div id="wrap">
    <header id="header">
  <div id="header-outer" class="outer">
    <div class="container">
      <div class="container-inner">
        <div id="header-title">
          <h1 class="logo-wrap">
            <a href="/" class="logo"></a>
          </h1>
          
            <h2 class="subtitle-wrap">
              <p class="subtitle">Design it, Code it, Build it. C# &amp; Sitecore!</p>
            </h2>
          
          
          <div class="mvp">
            <a href="http://www.sitecore.net/mvp" target="_blank">
              <img src="/about/index/MVP2016.jpg" alt="Sitecore MVP 2016-2020">
            </a>
            <a href="http://www.sitecore.net/mvp" target="_blank">
              <img src="/about/index/Technology2020.jpg" alt="Sitecore MVP 2016-2020">
            </a>
            <a href="http://www.sitecore.net/mvp" target="_blank">
              <img src="/about/index/Technology2019.jpg" alt="Sitecore MVP 2016-2020">
            </a>
            <a href="http://www.sitecore.net/mvp" target="_blank">
              <img src="/about/index/Technology2018.jpg" alt="Sitecore MVP 2016-2020">
            </a>
            <a href="http://www.sitecore.net/mvp" target="_blank">
                <img src="/about/index/Technology2017.jpg" alt="Sitecore MVP 2016-2020">
            </a>
            <a href="http://www.sitecore.net/mvp" target="_blank">
                <img src="/about/index/Technology2016.jpg" alt="Sitecore MVP 2016-2020">
            </a>
          </div>
          
        </div>
        <div id="header-inner" class="nav-container">
          <a id="main-nav-toggle" class="nav-icon"></a>
          <div class="nav-container-inner">
            <ul id="main-nav">
              
            </ul>
            <nav id="sub-nav">
              <div id="search-form-wrap">
                <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://www.sitecorenutsbolts.net"></form>
              </div>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>
    <div class="container">
      <div class="main-body container-inner">
        <div class="main-body-inner">
          <section id="main">
            <div class="main-body-header">

              <h1 class="header"><a class="page-title-link" href="/categories/Sitecore/">Sitecore</a></h1>
            </div>
            <div class="main-body-content">
              
  <article id="post-Advanced-Cache-Clearing" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
      <!--  -->
      
        <header class="article-header">
          
  
    <h1 class="article-title" itemprop="name">
      Advanced Cache Clearing
    </h1>
  

        </header>
      
      <p class="article-byline">
        <a href="/2016/04/26/Advanced-Cache-Clearing/" class="article-date">
  <time datetime="2016-04-26T18:02:18.000Z" itemprop="datePublished">2016-04-26</time>
</a>
      </p>
      <div class="article-entry" itemprop="articleBody">
        <code>Estimated reading time:<span class="eta"></span></code>
        <p>A recent post on <a href="http://stackoverflow.com/questions/36796980/sitecore-programmatically-clear-users-cache" target="_blank" rel="noopener">Stack Overflow</a> asked about clearing out the <code>HtmlCache</code> for a specific user, the short answer is in the post. But I thought I’d add some more detail to that answer here for anyone else wants to know the Sitecore Html Cache a little more in depth.</p>
<p>###What’s the HtmlCache??<br>The <code>HtmlCache</code> is the top level cache, sometimes call the web cache. It is used to store the rendered Html from your renderings and sublayouts if you are still using webforms. This cache can be configured on a per-site basis.</p>
<img src="/2016/04/26/Advanced-Cache-Clearing/cacheoverview.jpg" title="Caching Overview">
<p>Credit: <a href="http://learnsitecore.cmsuniverse.net/Developers/Articles/2009/07/CachingOverview.aspx" target="_blank" rel="noopener">Learn Sitecore: Caching Overview</a></p>
<p>You can enable the Html cache either on your rendering or sublayout item, or you can specify on each instance of a rendering in presentation. Each method includes options to vary the cached output based on defined parameters:</p>
<img src="/2016/04/26/Advanced-Cache-Clearing/cachevaryby.gif" title="Cache Vary By Parameters">
<p>###Why use it?<br>The simple answer is… performance! The Html cache is often the last consideration when imnplementing a Sitecore site. I feel that it should be one of the first. It really should be part of the overall plan of the site, because when used right it can provide massive performance gains.</p>
<p>#####Caching is not an excuse for slow code!<br>Don’t get the wrong idea, if you are using caching to band aid over badly performing code, you are going down a bad path!</p>
<p>But using the html cache on already well performing renderings can really help with how many requests per second the server can cope with.</p>
<p>###Generating the Cache Key<br>So how do all those parameters work? Well, we are going to deal with an MVC implementation as its a lot nicer to deal with, but the principles are the same, the code is just tightly hooked into the base web control class.</p>
<p>All those options on the vary by parameters simply change the way the Cache Key is built for the rendering. This is done via the <code>Sitecore.Mvc.Pipelines.Response.RenderRendering.GenerateCacheKey</code> processor that runs in the <code>mvc.RenderRendering</code> pipeline.</p>
<p>Every cache key starts by adding the unique key for the current rendering. That consists of a type and then some property values. For example a controller rendering key is built like this:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="string">"controller::"</span> + <span class="keyword">this</span>.ControllerName + <span class="string">"#"</span> + <span class="keyword">this</span>.ActionName;</span><br></pre></td></tr></table></figure></p>
<p>A view rendering is:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="string">"view::"</span> + <span class="keyword">this</span>.ViewPath;</span><br></pre></td></tr></table></figure></p>
<p>The sites current context language is also added into the Key</p>
<p>#####Careful when using MVC Area’s<br>You may notice that in the controller rendering, the <code>Area</code> field is not used anywhere to build the cache key. This means that if you have 2 controllers of the same name but in different area’s, you need to make sure that the action names are unique still. If not you will get contamination when the renderings output is cached.</p>
<p>Most of the time this will not be a problem, because its rare to not select any of the other vary by parameters, but it is something to keep in mind when designing your rendering hierarchy.</p>
<p>####Vary by:</p>
<ul>
<li>Data: This adds the rendering items path to the key: <code>&quot;_#data:&quot; + rendering.Item.Paths.Path;</code></li>
<li>Device: This adds the current <code>Context.GetDeviceName</code> to the key: <code>&quot;_#dev:&quot; + Context.GetDeviceName();</code></li>
<li>Login: This adds a boolean to the key that specifies if the user is logged in or out: <code>&quot;_#login:&quot; + (object) Context.IsLoggedIn;</code></li>
<li>Parameters: This concatenates all the rendering parameters to a query string and puts them in the key: <code>&quot;_#parm:&quot; + rendering.Parameters.ToQueryString();</code></li>
<li>Query String: Does what it says on the tin! Adds the current request query string to the key: <code>&quot;_#qs:&quot; + MainUtil.ConvertToString(request.QueryString, &quot;=&quot;, &quot;&amp;&quot;);</code></li>
<li>User: This appends the current Context user to the key. Note that if the user is not logged in, this will be <code>extranet/anonymous</code> when using a default site definition: <code>&quot;_#user:&quot; + Context.GetUserName();</code></li>
</ul>
<p>####Fun With Cache Keys<br>What this gives us is a really simple way to make sure that our cache key is generated with the right variation to give a nice performance boost on the site, but still provide relavent information to the user.</p>
<p>A while ago I wrote a post on <a href="http://www.sitecorenutsbolts.net/2014/12/02/Sitecore-MVC-Custom-Caching-Vary-by-External-Data/">caching a rendering using external data</a> - this showed how to add an element from some external data into the cache key. This might be useful when displaying dynamic pages of content that include external feeds or other non-Sitecore based content. For example a rendering that displayed an adverted served by an external ad server.</p>
<p>Another scenario we ran into recently was a site that had 3 states for a user.</p>
<ul>
<li>Anonymous</li>
<li>Registered</li>
<li>Subscribed</li>
</ul>
<p>In this case, you could register on the site and get free content, or subscribe and get premium content. For this we created a new cache key part that held the status for the user, this replaced the boolean for <strong>Vary By Logged In</strong> part.</p>
<p>###Advanced Cache Clearing<br>By default, the Html cache is cleared after a publish. On the <code>publish:end</code> and <code>publish:end:remote</code> events, the config sets up the HtmlCache clearer:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">event</span> <span class="attr">name</span>=<span class="string">"publish:end"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">handler</span> <span class="attr">type</span>=<span class="string">"Sitecore.Publishing.HtmlCacheClearer, Sitecore.Kernel"</span> <span class="attr">method</span>=<span class="string">"ClearCache"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sites</span> <span class="attr">hint</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">site</span>&gt;</span>website<span class="tag">&lt;/<span class="name">site</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sites</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">handler</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">event</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">event</span> <span class="attr">name</span>=<span class="string">"publish:end:remote"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">handler</span> <span class="attr">type</span>=<span class="string">"Sitecore.Publishing.HtmlCacheClearer, Sitecore.Kernel"</span> <span class="attr">method</span>=<span class="string">"ClearCache"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sites</span> <span class="attr">hint</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">site</span>&gt;</span>website<span class="tag">&lt;/<span class="name">site</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sites</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">handler</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">event</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>By default this cache clears right away on the event, but you can add an attribute to the Site Definition called <code>htmlCacheClearLatency</code> - this is a time span that specifies how long after the event is raised you want the cache to be cleared. This could be useful if you want to wait for indexes to be updated before clearing the cache.</p>
<p>But we can be a bit more refined than that!</p>
<p>The <code>HtmlCache</code> class inherits from <code>Sitecore.Caching.CustomCache</code> - so while we can clear all and remove by a certain key, there is an interesting litte method called <code>RemoveKeysContaining(string value)</code> and <code>RemovePrefix(true)</code>.</p>
<p>Both of these methods can be used to selectively remove entries from the cache. In the Stack Overflow question at the top of the post, the developer wanted to remove a specified user from the cache.  If the vary by parameters have been set correctly, this becomes a simple task. </p>
<p>Lets say we have a rendering called <code>User Profile</code>, we set the caching up like this:</p>
<img src="/2016/04/26/Advanced-Cache-Clearing/userprofilecache.gif" title="User Profile Vary By Parameters">
<p>The rendering is a controller rendering setup like this:</p>
<img src="/2016/04/26/Advanced-Cache-Clearing/userprofilerendering.png" title="User Profile rendering">
<p>For my login, the cache key would be:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;controller::Users#Profile_#lang:en_#login:True_#user:extranet/richardseal&quot;</span><br></pre></td></tr></table></figure></p>
<p>When I update my profile by a form submission, I want to clear this renderings cache, and any other renderings that might use part of my profile. This is nice and simple:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Need to clear the cache for the header and the user profile....</span></span><br><span class="line"><span class="keyword">var</span> htmlCache = CacheManager.GetHtmlCache(Context.Site);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove all cache keys that contain the currently logged in user.</span></span><br><span class="line"><span class="keyword">var</span> cacheKeyPart = <span class="string">$"_#login:True_#user:<span class="subst">&#123;Context.GetUserName()&#125;</span>"</span>;</span><br><span class="line">htmlCache.RemoveKeysContaining(cacheKeyPart);</span><br></pre></td></tr></table></figure>
<p>What about clearing all cached renderings that use a specific item as thier datasource?<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// Need to clear the cache for the current context item</span><br><span class="line">var htmlCache = CacheManager.GetHtmlCache(Context.Site);</span><br><span class="line">var path = Sitecore.Context.Item.Paths.Path;</span><br><span class="line"></span><br><span class="line">// Remove all cache keys that contain the currently logged in user.</span><br><span class="line">var cacheKeyPart = $&quot;_#data:&#123;path&#125;&quot;;</span><br><span class="line">htmlCache.RemoveKeysContaining(cacheKeyPart);</span><br></pre></td></tr></table></figure></p>
<p>The possibilities are endless. So have fun with the HtmlCache - hopefully this will be of use to someone :)</p>
<p>– Richard</p>

      </div>
      <footer class="article-footer">
        <a data-url="http://www.sitecorenutsbolts.net/2016/04/26/Advanced-Cache-Clearing/" data-id="cka5tzg8j001fgsvrm73e489o" class="article-share-link">Share</a>
        
          <a href="http://www.sitecorenutsbolts.net/2016/04/26/Advanced-Cache-Clearing/#comments" class="article-comment-link">Comments</a>
        
        
      </footer>
    </div>
  </article>
  
    <section id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    </section>
  


<!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-55d6161f325b85fa" async="async"></script>
            </div>
          </section>
          <aside id="sidebar">
  <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
  <div class="sidebar-top">
    <p>follow:</p>
    <ul class="social-links">
      
    </ul>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/05/27/Watchout-You-are-in-the-web-db/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">newer</strong>
      <p class="article-nav-title">
        
          Watchout! You are in the web db!
        
      </p>
      <i class="icon" id="icon-chevron-right"></i>
    </a>
  
  
    <a href="/2016/03/28/Fortis-V4-Beta-Changes/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">older</strong>
      <p class="article-nav-title">Fortis V4 Beta Changes</p>
      <i class="icon" id="icon-chevron-left"></i>
    </a>
  
</nav>

  
  <div class="widgets-container">
    
  </div>
</aside>
        </div>
      </div>
    </div>
    <footer id="footer">
  
  <div class="container">
    <div class="container-inner">
      <a id="back-to-top" href="javascript:;"><i class="icon" id="icon-angle-up"></i></a>
      <div class="credit">
        <h1 class="logo-wrap">
          <a href="/" class="logo"></a>
        </h1>
        <p>&copy; 2020 Richard Seal</p>
        <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>.
      </p></div>
    </div>
  </div>
</footer>
    
<script>
  var disqus_shortname = 'sitecorenutsbolts';
  
  var disqus_url = 'http://www.sitecorenutsbolts.net/2016/04/26/Advanced-Cache-Clearing/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



  <script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>






<script src="/js/html-patch.js"></script>
<script src="/js/script.js"></script>
<script src="/js/readingTime.min.js"></script>

<script>
  $(function() {
    $('.article-entry').readingTime();
  });
</script>

  </div>
</body>
</html>
